<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Women Safety SOS</title>
  <style>
    html, body {
      height: 100%;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(120deg, #141922 0%, #232a36 60%, #13151a 100%);
      color: #eaeaea;
      width: 100vw;
      box-sizing: border-box;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Prevent scroll bounce on mobile apps */
      overscroll-behavior: none;
      touch-action: manipulation;
    }
    .wrapper {
      background: rgba(22, 26, 34, 0.68);
      box-shadow: 0 10px 38px 0 rgba(20,20,30,0.45), 0 1.5px 8px 0 rgba(20,20,30,0.30);
      border-radius: 32px;
      padding: 2.3rem 1.6rem 2.5rem 1.6rem;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 1.65rem;
      width: 90vw;
      max-width: 360px;
      min-width: 0;
      height: auto;
      margin: 0 auto;
      backdrop-filter: blur(26px) saturate(1.4);
      -webkit-backdrop-filter: blur(26px) saturate(1.4);
      transition: box-shadow 0.2s;
      border: 1.5px solid rgba(36, 42, 54, 0.23);
      position: relative;
      box-sizing: border-box;
      /* Remove vertical offset for full viewport */
      top: 0; left: 0; right: 0; bottom: 0;
      justify-content: flex-start;
    }
    .sos-alert-box {
      background: rgba(30, 34, 44, 0.53);
      box-shadow: 0 2px 18px 0 rgba(20,22,30,0.18);
      border-radius: 28px;
      padding: 1.35rem 1.2rem;
      margin-bottom: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      font-weight: 700;
      color: #eaeaea;
      letter-spacing: -0.018em;
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      min-height: 72px;
      text-align: center;
      user-select: none;
      /* frosted glass effect */
      backdrop-filter: blur(12px) saturate(1.15);
      -webkit-backdrop-filter: blur(12px) saturate(1.15);
      border: 1.2px solid rgba(60, 70, 85, 0.18);
    }
    h1 {
      margin: 0 0 0.1em 0;
      font-weight: 700;
      font-size: 1.45rem;
      text-align: center;
      color: #eaeaea;
      letter-spacing: -0.015em;
      user-select: none;
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      text-shadow: 0 1px 8px rgba(16,20,28,0.12);
    }
    .btn-row {
      display: flex;
      gap: 1.1rem;
      width: 100%;
      justify-content: center;
      max-width: 420px;
    }
    .btn-row.push-shake-row {
      flex-direction: row;
      gap: 1.1rem;
      margin-bottom: 0.1rem;
      width: 100%;
      justify-content: center;
      align-items: stretch;
    }
    .btn-row.sos-row {
      flex-direction: row;
      gap: 1.1rem;
      margin-bottom: 0.5rem;
      justify-content: center;
      align-items: center;
      width: 100%;
    }
    button {
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      font-size: 1.07rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      color: #f2f3f7;
      background: rgba(34, 36, 45, 0.82);
      border: 1.2px solid rgba(60,60,90,0.15);
      border-radius: 16px;
      padding: 0.7rem 1.5rem;
      min-width: 124px;
      max-width: 220px;
      cursor: pointer;
      box-shadow: none;
      transition: background 0.15s, box-shadow 0.15s, border-color 0.15s, color 0.15s;
      outline: none;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      position: relative;
      overflow: hidden;
    }
    button:active {
      box-shadow: 0 0 0 2px rgba(50, 80, 200, 0.09);
    }
    button:hover, button:focus-visible {
      background: rgba(38, 44, 60, 0.95);
      border-color: #32405a;
      color: #fff;
      box-shadow: 0 2px 8px 0 rgba(50, 80, 200, 0.09);
    }
    .push-btn, .shake-btn {
      flex: 1 1 0px;
      font-size: 1.07rem;
      border-radius: 16px;
      background: rgba(36, 38, 50, 0.81);
      color: #eaeaea;
      border: 1.2px solid rgba(60,60,90,0.15);
      font-weight: 600;
      box-shadow: none;
      transition: background 0.15s, box-shadow 0.15s, border-color 0.15s, color 0.15s;
      min-width: 0;
      padding: 0.7rem 1.1rem;
      min-height: 44px;
    }
    .push-btn:hover, .push-btn:focus-visible,
    .shake-btn:hover, .shake-btn:focus-visible {
      background: rgba(38, 44, 60, 0.93);
      color: #fff;
      border-color: #32405a;
      box-shadow: 0 2px 8px 0 rgba(50, 80, 200, 0.10);
    }
    .sos-btn {
      background: linear-gradient(145deg, #232427 0%, #18191b 100%);
      color: #eaeaea;
      border: 2.5px solid rgba(110,120,140,0.32);
      font-weight: 900;
      width: 250px;
      height: 250px;
      min-width: 0;
      min-height: 0;
      padding: 0;
      font-size: 2.3rem;
      border-radius: 50%;
      /* Apple-like glossy effect */
      box-shadow:
        0 0 26px 8px rgba(255,255,255,0.18),
        0 0 0 0 rgba(36,42,60,0.09),
        0 0 0 2px rgba(255,255,255,0.18) inset,
        0 8px 20px 0 rgba(0,0,0,0.22) inset;
      animation: sosPulse 2.8s cubic-bezier(0.4,0,0.2,1) infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition:
        background 0.18s,
        box-shadow 0.22s cubic-bezier(0.4,0,0.2,1),
        border-color 0.18s,
        color 0.18s,
        transform 0.22s cubic-bezier(0.4,0,0.2,1);
      letter-spacing: 0.01em;
      margin-right: 0.25em;
      margin-left: 0.25em;
      position: relative;
      z-index: 1;
      box-sizing: border-box;
      /* Prominent for mobile */
      flex-shrink: 0;
      /* Soft inner glow (white) for Apple effect */
      box-shadow:
        0 0 26px 8px rgba(255,255,255,0.18),
        0 0 0 2px rgba(255,255,255,0.22),
        0 0 0 0 rgba(36,42,60,0.09),
        0 8px 22px 0 rgba(0,0,0,0.23) inset,
        0 0 22px 0 rgba(255,255,255,0.14) inset;
      /* Subtle glossy shine overlay */
      overflow: visible;
    }
    .sos-btn::before {
      /* Apple glassy shine overlay */
      content: "";
      position: absolute;
      top: 14px; left: 25px; right: 25px; height: 38px;
      background: linear-gradient(120deg, rgba(255,255,255,0.22) 0%, rgba(255,255,255,0.08) 100%);
      border-radius: 50% 50% 40% 40%/60% 60% 30% 30%;
      pointer-events: none;
      z-index: 2;
      filter: blur(0.5px);
      opacity: 0.88;
    }
    .sos-btn:hover, .sos-btn:focus-visible {
      background: linear-gradient(145deg, #2b2d31 0%, #191a1d 100%);
      box-shadow:
        0 0 46px 16px rgba(255,255,255,0.28),
        0 0 0 8px rgba(255,255,255,0.13),
        0 0 0 2px rgba(255,255,255,0.24) inset,
        0 8px 22px 0 rgba(0,0,0,0.26) inset,
        0 0 28px 0 rgba(255,255,255,0.17) inset;
      color: #fff;
      border-color: #4f5a75;
      transform: scale(1.045);
      transition:
        background 0.18s,
        box-shadow 0.22s cubic-bezier(0.4,0,0.2,1),
        border-color 0.18s,
        color 0.18s,
        transform 0.22s cubic-bezier(0.4,0,0.2,1);
    }
    @keyframes sosPulse {
      0% {
        box-shadow:
          0 0 26px 8px rgba(255,255,255,0.18),
          0 0 0 2px rgba(255,255,255,0.22),
          0 0 0 0 rgba(36,42,60,0.09),
          0 8px 22px 0 rgba(0,0,0,0.23) inset,
          0 0 22px 0 rgba(255,255,255,0.14) inset;
        filter: brightness(1);
      }
      45% {
        box-shadow:
          0 0 38px 16px rgba(255,255,255,0.22),
          0 0 0 6px rgba(255,255,255,0.18),
          0 0 0 0 rgba(36,42,60,0.13),
          0 10px 28px 0 rgba(0,0,0,0.25) inset,
          0 0 32px 0 rgba(255,255,255,0.17) inset;
        filter: brightness(1.08);
      }
      70% {
        box-shadow:
          0 0 18px 6px rgba(255,255,255,0.13),
          0 0 0 1px rgba(255,255,255,0.13),
          0 0 0 0 rgba(36,42,60,0.09),
          0 7px 15px 0 rgba(0,0,0,0.20) inset,
          0 0 18px 0 rgba(255,255,255,0.10) inset;
        filter: brightness(1);
      }
      100% {
        box-shadow:
          0 0 26px 8px rgba(255,255,255,0.18),
          0 0 0 2px rgba(255,255,255,0.22),
          0 0 0 0 rgba(36,42,60,0.09),
          0 8px 22px 0 rgba(0,0,0,0.23) inset,
          0 0 22px 0 rgba(255,255,255,0.14) inset;
        filter: brightness(1);
      }
    }
    .cancel-btn {
      background: rgba(36, 38, 50, 0.81);
      color: #b1b5c0;
      border: 1.6px solid rgba(60,60,90,0.18);
      font-weight: 700;
      border-radius: 36px;
      width: 170px;
      height: 80px;
      padding: 0;
      font-size: 1.22rem;
      box-shadow: none;
      transition: background 0.15s, box-shadow 0.15s, border-color 0.15s, color 0.15s;
      min-width: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .cancel-btn:hover, .cancel-btn:focus-visible {
      background: rgba(46, 52, 70, 0.92);
      color: #fff;
      border-color: #32405a;
      box-shadow: 0 2px 8px 0 rgba(50, 80, 200, 0.09);
    }
    #status {
      margin-top: 0.2em;
      font-weight: 600;
      font-size: 1.13rem;
      text-align: center;
      color: #b1b5c0;
      user-select: none;
      min-height: 1.4em;
      width: 100%;
      max-width: 420px;
      background: transparent;
      border: none;
      margin-bottom: 0.2em;
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      letter-spacing: 0.01em;
    }
    /* Sidebar styles (ambient Mac style) */
    #sidebar {
      position: fixed;
      top: 0; left: 0;
      height: 100vh;
      width: 265px;
      background: rgba(22, 26, 34, 0.93);
      box-shadow: 2px 0 32px 2px rgba(10,12,18,0.16);
      border-top-right-radius: 24px;
      border-bottom-right-radius: 24px;
      z-index: 101;
      transform: translateX(-110%);
      transition: transform 0.28s cubic-bezier(.4,0,.2,1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 24px 0 24px 0;
      box-sizing: border-box;
      backdrop-filter: blur(22px) saturate(1.18);
      -webkit-backdrop-filter: blur(22px) saturate(1.18);
      border-right: 1.5px solid rgba(36, 42, 54, 0.23);
    }
    #sidebar.open {
      transform: translateX(0);
    }
    .sidebar-content {
      padding: 0 5px;
    }
    .sidebar-footer {
      padding: 0 28px;
      margin-bottom: 1.5rem;
    }
    .sidebar-edit-btn,
    .sidebar-logout-btn {
      width: 100%;
      background: rgba(34, 36, 45, 0.82);
      border: 1.1px solid rgba(60,60,90,0.14);
      color: #eaeaea;
      font-size: 1.07rem;
      border-radius: 13px;
      padding: 0.85rem 0;
      margin-bottom: 1rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s, color 0.15s;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 0.7em;
    }
    .sidebar-edit-btn:hover,
    .sidebar-edit-btn:focus-visible {
      background: rgba(38, 44, 60, 0.97);
      border-color: #32405a;
      color: #fff;
    }
    .sidebar-edit-btn {
      margin-top: 0.5rem;
      margin-bottom: 0;
    }
    .sidebar-logout-btn {
      margin-bottom: 0;
      color: #b1b5c0;
      font-weight: 700;
    }
    .sidebar-logout-btn:hover, .sidebar-logout-btn:focus-visible {
      background: rgba(38, 44, 60, 0.97);
      color: #fff;
      border-color: #32405a;
    }
    #sidebar-toggle {
      position: fixed;
      top: 58px;   /* 32px + 20px down */
      left: 0px;  /* 28px - 28px to the left (moved further left) */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      z-index: 120;
      cursor: pointer;
      background: none;
      border: none;
      box-shadow: none;
      border-radius: 0;
      width: auto;
      height: auto;
      transition: none;
      padding: 0;
      background: none !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      box-shadow: none !important;
    }
    #sidebar-toggle .dot {
      display: block;
      width: 6px;
      height: 6px;
      background: #4a4e5c;
      border-radius: 50%;
      transition: background 0.14s;
    }
    #sidebar-toggle:hover .dot, #sidebar-toggle:focus-visible .dot {
      background: #b1b5c0;
    }
    @media (max-width: 700px) {
      .wrapper {
        padding: 1.1rem 0.2rem 1.2rem 0.2rem;
        height: auto;
        width: 90vw;
        max-width: 360px;
        gap: 1rem;
        border-radius: 18px;
      }
      .btn-row.sos-row {
        max-width: 100%;
        gap: 0.7rem;
        margin-bottom: 0.6rem;
        flex-direction: row;
        align-items: center;
        justify-content: center;
      }
      .btn-row.push-shake-row {
        max-width: 100%;
        width: 100%;
        gap: 0.7rem;
        align-items: stretch;
        flex-direction: row;
        justify-content: center;
      }
      .btn-row.sos-row button.sos-btn {
        width: 40vw;
        max-width: 110px;
        min-width: 65px;
        height: 40vw;
        max-height: 110px;
        min-height: 65px;
        font-size: 1.18rem;
        margin: 0;
        border-radius: 50%;
        box-shadow: 0 0 10px 3px rgba(255,255,255,0.14), 0 0 0 0 rgba(36,42,60,0.09);
        flex-shrink: 0;
      }
      .btn-row.sos-row button.cancel-btn {
        width: 40vw;
        max-width: 100px;
        min-width: 65px;
        height: 56vw;
        max-height: 70px;
        min-height: 48px;
        font-size: 1.08rem;
        margin: 0;
        border-radius: 32px;
        flex-shrink: 0;
      }
      .btn-row.push-shake-row button {
        width: 48vw;
        max-width: 150px;
        font-size: 1.01rem;
        padding: 0.7rem 0.8rem;
      }
      #status {
        max-width: 100%;
        font-size: 0.97rem;
      }
      #sidebar {
        width: 82vw;
        min-width: 0;
        max-width: 98vw;
        border-top-right-radius: 18px;
        border-bottom-right-radius: 18px;
        padding: 14px 0 18px 0;
      }
      #sidebar-toggle {
        top: 40px;   /* 14px + 20px down */
        left: -18px;   /* moved further to the left on small screens */
      }
      .sidebar-content, .sidebar-footer {
        padding: 0 14px;
      }
      .sos-alert-box {
        font-size: 1.25rem;
        padding: 0.7rem 0.5rem;
        min-height: 38px;
      }
      /* Make sure buttons never overflow */
      .btn-row {
        width: 100%;
        max-width: 100%;
      }
    }
    @media (max-width: 420px) {
      .wrapper {
        padding: 0.5rem 0.1rem 1rem 0.1rem;
        border-radius: 10px;
        width: 90vw;
        max-width: 360px;
      }
      .btn-row.sos-row button.sos-btn {
        width: 32vw;
        max-width: 60px;
        min-width: 34px;
        height: 32vw;
        max-height: 60px;
        min-height: 34px;
        font-size: 0.98rem;
        border-radius: 50%;
        box-shadow: 0 0 7px 2px rgba(255,255,255,0.13), 0 0 0 0 rgba(36,42,60,0.09);
      }
      .btn-row.sos-row button.cancel-btn {
        width: 34vw;
        max-width: 60px;
        min-width: 36px;
        height: 42vw;
        max-height: 54px;
        min-height: 36px;
        font-size: 0.93rem;
        padding: 0;
        border-radius: 22px;
      }
      .btn-row.push-shake-row button {
        font-size: 0.97rem;
        padding: 0.6rem 0.6rem;
        width: 48vw;
        max-width: 120px;
      }
      .sos-alert-box {
        font-size: 1.02rem;
        min-height: 28px;
        padding: 0.5rem 0.2rem;
      }
    }
    @media (max-width: 370px) {
      .wrapper {
        padding: 0.2rem 0.02rem 0.7rem 0.02rem;
        width: 90vw;
        max-width: 360px;
      }
      .btn-row.sos-row button.sos-btn {
        width: 28vw;
        max-width: 36px;
        min-width: 18px;
        height: 28vw;
        max-height: 36px;
        min-height: 18px;
        font-size: 0.78rem;
        border-radius: 50%;
        box-shadow: 0 0 4px 1px rgba(255,255,255,0.12), 0 0 0 0 rgba(36,42,60,0.09);
      }
      .btn-row.sos-row button.cancel-btn {
        width: 20vw;
        max-width: 32px;
        min-width: 16px;
        height: 32vw;
        max-height: 36px;
        min-height: 22px;
        font-size: 0.79rem;
        padding: 0;
        border-radius: 12px;
      }
      .sos-alert-box {
        font-size: 0.85rem;
        min-height: 18px;
        padding: 0.3rem 0.1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <nav id="sidebar">
    <div class="sidebar-content">
      <button class="sidebar-edit-btn" onclick="window.location.href='editDatabase.html'">✍️ Edit Contacts</button>
    </div>
    <div class="sidebar-footer">
      <button class="sidebar-logout-btn" onclick="logout()">👋 Logout</button>
    </div>
  </nav>
  <!-- Three dots button -->
  <button id="sidebar-toggle" aria-label="Open menu">
    <span class="dot"></span>
    <span class="dot"></span>
    <span class="dot"></span>
  </button>
  <div class="wrapper">
    <div class="sos-alert-box">
      🚨 SOS Emergency Alert
    </div>
    <h1>Women Safety SOS</h1>
    <div class="btn-row push-shake-row">
      <button class="push-btn" onclick="enablePush()">Push Notification</button>
      <button class="shake-btn" onclick="enableShake()">Shake Detection</button>
    </div>
    <div class="btn-row sos-row">
      <button class="sos-btn" onclick="sendSOS()">Send SOS</button>
      <button class="cancel-btn" onclick="cancelSOS()">Cancel SOS</button>
    </div>
    <p id="status">No alert active</p>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCvoJdOzp9v8aWdnWhGpoBrB_ZOBh-L648",
      authDomain: "women-saftey-a3bac.firebaseapp.com",
      projectId: "women-saftey-a3bac",
      storageBucket: "women-saftey-a3bac.firebasestorage.app",
      messagingSenderId: "40368489597",
      appId: "1:40368489597:web:cba8693d99900ea5461d14"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const messaging = firebase.messaging();
    const db = firebase.firestore();

    // Check auth state on page load and ensure profile is complete
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      window.currentUserId = user.uid;
      try {
        const userDocRef = db.collection("users").doc(user.uid);
        const userDoc = await userDocRef.get();
        if (!userDoc.exists) {
          window.location.href = "completeProfile.html";
          return;
        }
        const userData = userDoc.data();
        // Check for placeholders
        if (!userData || userData.name === "Your Name" || userData.phone === "Your Phone") {
          window.location.href = "completeProfile.html";
          return;
        }
        // User is authenticated and profile is complete; continue as normal
      } catch (err) {
        console.error("Error fetching user profile:", err);
        alert("Failed to verify profile. Please try again.");
        // Optionally redirect to login
        window.location.href = "login.html";
      }
    });

    // Sidebar logout handler
    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }

  // Use Render backend in production
  const backendBase =
    (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
      ? "http://localhost:5000"
      : "https://women-safety-app-78gl.onrender.com";  // <-- new Render backend URL

    async function sendSOS() {
      showStatus();
      if (!navigator.geolocation) {
        alert("Geolocation not supported");
        return;
      }
      if (!window.currentUserId) {
        alert("User not authenticated.");
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        console.log(`User location: lat=${lat}, lon=${lon}`);

        try {
          const response = await fetch(`${backendBase}/alert`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: window.currentUserId, lat, lon })
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(`Server responded with status ${response.status}: ${text}`);
          }

          const data = await response.json();
          console.log("Alert response:", data);
          document.getElementById("status").innerText = "🚨 SOS sent! Location shared.";
        } catch (err) {
          console.error("Error sending SOS:", err);
          alert("Failed to send SOS. Check console for details.");
        }
      }, (error) => {
        console.error("Geolocation error:", error);
        alert("Failed to get location. Make sure location services are enabled.");
      });
    }

    function cancelSOS() {
      document.getElementById("status").innerText = "❌ SOS canceled.";
      // Later: Tell backend to cancel alert
    }

    function showStatus() {
      const statusEl = document.getElementById("status");
      if (statusEl.style.display === "none" || statusEl.style.display === "") {
        statusEl.style.display = "block";
      }
    }
  </script>

  <script>
    // --- Shake Detection ---
    let shakeThreshold = 18; // adjust sensitivity
    let lastX = null, lastY = null, lastZ = null;
    let lastTime = 0;
    let shakeCooldown = false;

    function enableShake() {
      showStatus();
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
          .then(state => { if (state === 'granted') window.addEventListener('devicemotion', onDeviceMotion); })
          .catch(console.error);
      } else {
        window.addEventListener('devicemotion', onDeviceMotion);
      }
    }

    function onDeviceMotion(e) {
      const acc = e.accelerationIncludingGravity;
      if (!acc) return;
      const curTime = Date.now();
      if ((curTime - lastTime) < 100) return;
      const { x, y, z } = acc;
      if (lastX !== null) {
        const delta = Math.abs(x - lastX) + Math.abs(y - lastY) + Math.abs(z - lastZ);
        if (delta > shakeThreshold && !shakeCooldown) {
          shakeCooldown = true;
          triggerShakeSOS();
          setTimeout(() => shakeCooldown = false, 5000);
        }
      }
      lastTime = curTime;
      lastX = x; lastY = y; lastZ = z;
    }

    function triggerShakeSOS() {
      document.getElementById('status').innerText = '🚨 SOS triggered by Shake';
      showStatus();
      sendSOS();
    }

  </script>

  <script>
async function enablePush() {
  showStatus();
  if (!window.currentUserId) {
    alert("User not authenticated.");
    return;
  }
  try {
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      alert('Notification permission denied');
      return;
    }

    // Register the service worker
    const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
    console.log('Service Worker registered:', registration);

    // Wait until the service worker is fully active
    await navigator.serviceWorker.ready;

    // Get FCM token using the registered service worker
    const token = await messaging.getToken({
      vapidKey: 'BPs_OysUnZWqCKikKqEPfCY_khr4yXZ4aDUEQcbWf25XBY8lugVWcQc3EOowJRoyvkyxL0Mhl2e7z-Wf55iTWXA',
      serviceWorkerRegistration: registration
    });

    console.log('FCM Token:', token);
    alert('Push notifications enabled!');
    await registerToken(window.currentUserId, token);
  } catch (error) {
    console.error('Error getting permission or token', error);
    alert('Failed to enable push notifications. Check console for details.');
  }
}
  </script>

  <script>
    /*
    async function subscribeToTopic(userId, token) {
      try {
        const response = await fetch(`https://iid.googleapis.com/iid/v1/${token}/rel/topics/${userId}`, {
          method: "POST",
          headers: {
            "Authorization": "key=YOUR_SERVER_KEY"
          }
        });
        if (response.ok) {
          console.log(`Subscribed to topic ${userId} successfully.`);
        } else {
          console.error(`Failed to subscribe to topic ${userId}. Status: ${response.status}`);
        }
      } catch (error) {
        console.error('Error subscribing to topic:', error);
      }
    }
    */

    async function registerToken(userId, token) {
      try {
        const response = await fetch(`${backendBase}/register-token`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId, token })
        });
        if (response.ok) {
          console.log(`Token registered successfully for user ${userId}.`);
        } else {
          console.error(`Failed to register token for user ${userId}. Status: ${response.status}`);
        }
      } catch (error) {
        console.error('Error registering token:', error);
      }
    }

    messaging.onMessage((payload) => {
      alert('Push message received: ' + JSON.stringify(payload));
    });
  </script>

  <script>
    // Capacitor volumeSOS event listener
    if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.App) {
      window.Capacitor.Plugins.App.addListener('volumeSOS', () => {
        triggerShakeSOS();
      });
    } else if (window.addEventListener) {
      window.addEventListener('volumeSOS', () => {
        triggerShakeSOS();
      });
    }
  </script>

  <script>
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');

    function openSidebar() {
      sidebar.classList.add('open');
      toggleBtn.style.display = 'none';
    }

    function closeSidebar() {
      sidebar.classList.remove('open');
      toggleBtn.style.display = 'flex';
    }

    // Toggle open on click
    toggleBtn.addEventListener('click', () => {
      if (sidebar.classList.contains('open')) {
        closeSidebar();
      } else {
        openSidebar();
      }
    });

    // Close sidebar with ESC key
    document.addEventListener('keydown', (e) => {
      if (sidebar.classList.contains('open') && (e.key === "Escape" || e.key === "Esc")) {
        closeSidebar();
      }
    });

    // Close sidebar if click outside it (but not on toggle)
    document.addEventListener('click', (e) => {
      if (sidebar.classList.contains('open') &&
          !sidebar.contains(e.target) &&
          e.target !== toggleBtn &&
          !toggleBtn.contains(e.target)) {
        closeSidebar();
      }
    });
  </script>
  
</body>
</html>
